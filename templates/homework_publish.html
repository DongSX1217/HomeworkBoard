<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业布置系统</title>
    <link rel="stylesheet" href="/static/css/homework_publish.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h1 class="text-center mb-4"><i class="fas fa-edit me-2"></i>作业布置系统</h1>
                
                <!-- 消息提示 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% if confirm_data %}
                <!-- 确认页面 -->
                <div class="form-container">
                    <h2 class="text-center mb-4">确认作业信息</h2>
                    <div class="alert alert-warning" role="alert">
                        <h4 class="alert-heading">请确认以下作业信息</h4>
                        <p>请仔细检查以下作业信息，确认无误后再提交。</p>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>学科</strong>
                        </div>
                        <div class="card-body">
                            {{ confirm_data.subject }}
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>作业内容</strong>
                        </div>
                        <div class="card-body">
                            {{ confirm_data.content }}
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>标签</strong>
                        </div>
                        <div class="card-body">
                            {% if confirm_data.labels %}
                                {% for label in confirm_data.labels %}
                                    <span class="badge bg-primary me-1">{{ label }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">无标签</span>
                            {% endif %}
                        </div>
                    </div>
                    
                     <div class="card mb-3">
                        <div class="card-header">
                            <strong>截止日期</strong>
                        </div>
                        <div class="card-body">
                            {{ confirm_data.deadline if confirm_data.deadline != '无截止日期' else '无截止日期' }}
                        </div>
                    </div>
                    
                    <form method="POST" action="/homework/publish">
                        <input type="hidden" name="subject" value="{{ confirm_data.subject }}">
                        <input type="hidden" name="content" value="{{ confirm_data.content }}">
                        {% for label in confirm_data.labels %}
                        <input type="hidden" name="label_ids" value="{{ labels | selectattr('name', 'equalto', label) | map(attribute='id') | first }}">
                        {% endfor %}
                        <input type="hidden" name="deadline" value="{{ confirm_data.deadline if confirm_data.deadline != '无截止日期' else '' }}">
                        <input type="hidden" name="confirm" value="1">
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" name="return_to_edit" value="1" class="btn btn-outline-secondary me-md-2"><i class="fas fa-edit me-1"></i>返回修改</button>
                            <button type="submit" class="btn btn-success"><i class="fas fa-check-circle me-1"></i>确认提交</button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="form-container">
                    <form method="POST" action="/homework/publish">
                        <!-- 学科选择部分 -->
                        <div class="form-section">
                            <h3 class="section-title"><i class="fas fa-book"></i>学科选择</h3>
                            <p class="help-text">请选择相关的学科类别</p>
                            
                            <div class="mb-3">
                                <label class="form-label">学科 *</label>
                                <div>
                                    {% for subject in subjects %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input subject-radio" type="radio" name="subject" id="subject{{ subject.id }}" value="{{ subject.name }}" {{ 'checked' if session.get('publish_subject') == subject.name or (loop.first and not session.get('publish_subject')) else '' }}>
                                        <label class="form-check-label" for="subject{{ subject.id }}">{{ subject.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 内容输入部分 -->
                        <div class="form-section">
                            <h3 class="section-title"><i class="fas fa-file-alt"></i>内容详情</h3>
                            <p class="help-text">请详细描述您要提交的内容</p>
                            
                            <div class="mb-3">
                                <label for="content" class="form-label">内容 *</label>
                                <textarea class="form-control" id="content" name="content" rows="5" placeholder="请输入详细内容...">{{ session.get('publish_content', '') }}</textarea>
                                
                                <!-- 常用词区域 -->
                                <div id="common-words-section" class="mt-2">
                                    <div class="d-flex flex-wrap gap-1" id="subject-common-words">
                                        <!-- 科目常用词将通过JavaScript动态插入 -->
                                    </div>
                                    <div class="d-flex flex-wrap gap-1 mt-1" id="general-common-words">
                                        <!-- 通用常用词将通过JavaScript动态插入 -->
                                    </div>
                                </div>
                                
                                <div class="help-text mt-2">内容至少需要5个字符，请详细描述您要提交的内容。<a href="/subjects" target="_blank">管理常用词</a></div>
                            </div>
                        </div>
                        
                        <!-- 标签选择部分 -->
                        <div class="form-section">
                            <h3 class="section-title"><i class="fas fa-tags"></i>标签选择</h3>
                            <p class="help-text">请选择适用的标签（可多选）</p>
                            
                            <div class="mb-3">
                                <label class="form-label">标签</label>
                                <div class="checkbox-group">
                                    {% for label in labels %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input" name="label_ids" id="label{{ label.id }}" value="{{ label.id }}" {{ 'checked' if label.id in session.get('publish_label_ids', []) else '' }}>
                                        <label class="form-check-label" for="label{{ label.id }}">{{ label.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="help-text">选择适用的标签有助于分类和管理。<a href="/label/edit" target="_blank">管理标签</a></div>
                            </div>
                        </div>
                        
                        <!-- 截止日期部分 -->
                        <div class="form-section">
                             <h3 class="section-title"><i class="fas fa-calendar-alt"></i>截止日期</h3>
                            <p class="help-text">请设置任务的截止日期</p>
                            
                            <div class="mb-3">
                                <label for="deadline" class="form-label">截止日期</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="deadline" name="deadline" value="{{ session.get('publish_deadline', '') if session.get('publish_deadline', '') else tomorrow }}" min="{{ now.strftime('%Y-%m-%d') }}">
                                    <button class="btn btn-outline-secondary" type="button" id="clear-deadline">清空</button>
                                </div>
                                <div class="help-text">可以选择截止日期，也可以留空表示无截止日期。</div>
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('view_submissions') }}" class="btn btn-outline-secondary me-md-2"><i class="fas fa-list me-1"></i>查看提交记录</a>
                            <button type="submit" class="btn btn-submit"><i class="fas fa-paper-plane me-1"></i>布置作业</button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 设置最小日期为今天
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deadline').min = today;
            
            // 添加清空截止日期功能
            document.getElementById('clear-deadline').addEventListener('click', function() {
                document.getElementById('deadline').value = '';
            });
            
            // 常用词相关变量
            const subjectsData = {{ subjects | tojson }};
            const contentTextarea = document.getElementById('content');
            
            // 监听科目选择变化
            const subjectRadios = document.querySelectorAll('.subject-radio');
            subjectRadios.forEach(radio => {
                radio.addEventListener('change', updateCommonWords);
            });
            
            // 页面加载完成后初始化常用词显示
            updateCommonWords();
            
            // 更新常用词显示
            function updateCommonWords() {
                const selectedSubjectName = document.querySelector('.subject-radio:checked')?.value || subjectsData[0]?.name;
                const subjectCommonWordsContainer = document.getElementById('subject-common-words');
                const generalCommonWordsContainer = document.getElementById('general-common-words');
                
                // 清空容器
                subjectCommonWordsContainer.innerHTML = '';
                generalCommonWordsContainer.innerHTML = '';
                
                // 找到选中的科目
                const selectedSubject = subjectsData.find(subject => subject.name === selectedSubjectName);
                
                // 收集所有词并统计词频，出现多次的作为通用词
                const allWords = [];
                subjectsData.forEach(subject => {
                    if (subject.common_words) {
                        allWords.push(...subject.common_words);
                    }
                });
                
                // 统计词频，出现多次的作为通用词
                const wordCount = {};
                allWords.forEach(word => {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                });
                
                // 先显示通用常用词
                const generalWords = Object.entries(wordCount)
                    .filter(([word, count]) => count > 1)
                    .map(([word, count]) => word);
                
                    if (generalWords.length > 0) {
                    const title = document.createElement('div');
                    title.className = 'fw-bold mt-2 mb-1';
                    title.textContent = '通用常用词:';
                    generalCommonWordsContainer.appendChild(title);
                    
                    generalWords.forEach(word => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-secondary word-badge cursor-pointer';
                        badge.textContent = word;
                        badge.style.cursor = 'pointer';
                        badge.addEventListener('click', () => insertWordToContent(word));
                        generalCommonWordsContainer.appendChild(badge);
                    });
                }

                // 显示科目专用常用词（排除通用词）
                if (selectedSubject && selectedSubject.common_words && selectedSubject.common_words.length > 0) {
                    const title = document.createElement('div');
                    title.className = 'fw-bold mt-2 mb-1';
                    title.textContent = selectedSubject.name + '常用词:';
                    subjectCommonWordsContainer.appendChild(title);
                    
                    // 只显示该科目的专用词（不是通用词）
                    const subjectSpecificWords = selectedSubject.common_words.filter(word => !generalWords.includes(word));
                    if (subjectSpecificWords.length > 0) {
                        subjectSpecificWords.forEach(word => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary word-badge cursor-pointer';
                            badge.textContent = word;
                            badge.style.cursor = 'pointer';
                            badge.addEventListener('click', () => insertWordToContent(word));
                            subjectCommonWordsContainer.appendChild(badge);
                        });
                    } else {
                        const noWords = document.createElement('span');
                        noWords.className = 'text-muted';
                        noWords.textContent = '暂无专用词';
                        subjectCommonWordsContainer.appendChild(noWords);
                    }
                }
            }

            // 插入词语到内容末尾
            function insertWordToContent(word) {
                const content = contentTextarea.value;
                const newContent = content + word; 
                contentTextarea.value = newContent;
                contentTextarea.focus();
            }
        });
    </script>
</body>
</html>