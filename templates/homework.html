<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业公告板</title>
    <link rel="stylesheet" href="/static/css/homework.css">
</head>
<body>
    <div class="container">
        <button class="home-button" onclick="location.href='/'">主页</button>
        
        <h1>人大附中三亚学校高一(4)班作业公告板</h1>
        <div class="top-buttons">
            <button onclick="location.href='/homework/publish'">添加作业</button>
            <button onclick="openSettings()">设置</button>
            <button onclick="toggleFullscreen()">全屏</button>
        </div>
        
        <div class="columns" id="homeworkContainer">
            {% if submissions %}
                {% for subject, subject_submissions in submissions.items() %}
                <div class="subject-section">
                    <div class="subject-title">{{ subject }}</div>
                    <ul class="homework-list">
                        {% for submission in subject_submissions %}
                        <li class="homework-item" data-deadline="{{ submission.deadline }}">
                            <div class="content-wrapper">
                                <span class="content">{{ submission.content | replace('\r\n', '
') | replace('\n', '
') | replace('\r', '
') }}</span>
                                <span class="labels">
                                    {% for label_name in submission.labels %}
                                        {% set label_obj = (labels | selectattr('name', 'equalto', label_name) | first) %}
                                        <span class="label-tag" {% if label_obj %}style="background-color: {{ label_obj.color }}"{% endif %}>{{ label_name }}</span>
                                    {% endfor %}
                                </span>
                            </div>
                            <div class="dates-container">
                                <div class="deadline">截止日期: {{ submission.deadline[5:] }}</div>
                                <div class="timestamp">发布时间: {{ submission.timestamp[5:-3] }}</div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-submissions">暂无作业信息</div>
            {% endif %}
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h2>设置</h2>
            <div class="setting-group">
                <label for="refreshInterval">刷新间隔（秒）：</label>
                <input type="number" id="refreshInterval" min="10" max="3600" value="60">
            </div>
            <div class="setting-group">
                <label for="fontSize">字体大小：</label>
                <select id="fontSize">
                    <option value="15">小</option>
                    <option value="20" selected>中</option>
                    <option value="26">大</option>
                    <option value="34">超大</option>
                </select>
            </div>
            <div class="setting-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="hideExpired">
                    <label for="hideExpired">不显示已截止的作业</label>
                </div>
            </div>
            <button class="save-settings" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <script>
        let refreshInterval;
        let intervalId;
        let isFullscreen = false;
        let globalLabels = []; // 全局标签缓存
    
        // 页面加载完成后初始化
        window.onload = function() {
            loadSettings();
            startAutoRefresh();
            applyHideExpired();
        };
    
        // 加载设置（从cookie）
        function loadSettings() {
            const savedInterval = getCookie("refreshInterval");
            if (savedInterval) {
                refreshInterval = parseInt(savedInterval);
                document.getElementById("refreshInterval").value = refreshInterval;
            } else {
                refreshInterval = 60;
            }
            const savedFontSize = getCookie("fontSize");
            if (savedFontSize) {
                document.body.style.fontSize = savedFontSize + 'px';
                document.getElementById("fontSize").value = savedFontSize;
            }
            const hideExpired = getCookie("hideExpired");
            if (hideExpired === "true") {
                document.getElementById("hideExpired").checked = true;
                applyHideExpired();
            }
        }
    
        // 保存设置（到cookie）
        function saveSettings() {
            const newInterval = document.getElementById("refreshInterval").value;
            if (newInterval >= 10 && newInterval <= 3600) {
                refreshInterval = parseInt(newInterval);
                setCookie("refreshInterval", refreshInterval, 30);
                if (intervalId) clearInterval(intervalId);
                startAutoRefresh();
            } else {
                alert('刷新间隔必须在10-3600秒之间');
                return;
            }
            const fontSize = document.getElementById("fontSize").value;
            document.body.style.fontSize = fontSize + 'px';
            setCookie("fontSize", fontSize, 30);
            const hideExpired = document.getElementById("hideExpired").checked;
            setCookie("hideExpired", hideExpired, 30);
            applyHideExpired();
            closeSettings();
            alert('设置已保存');
        }
    
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }
    
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
    
        // 开始自动刷新
        function startAutoRefresh() {
            fetchHomeworkAndLabels();
            intervalId = setInterval(fetchHomeworkAndLabels, refreshInterval * 1000);
        }
    
        // 获取作业和标签数据
        function fetchHomeworkAndLabels() {
            fetch('/api/homework')
                .then(response => response.json())
                .then(data => {
                    globalLabels = data.labels || [];
                    updateHomeworkContainer(data.submissions, globalLabels);
                })
                .catch(error => {
                    console.error('获取作业数据失败:', error);
                });
        }
    
        // 动态分栏参数
        function getColumnCount() {
            if (window.innerWidth <= 600) return 1;
            if (window.innerWidth <= 900) return 2;
            if (window.innerWidth <= 1200) return 3;
            return 4;
        }
    
        // 更新作业容器（智能分栏，更均匀地分配内容）
        function updateHomeworkContainer(submissions, labels) {
            const container = document.getElementById('homeworkContainer');
            container.innerHTML = '';
            
            if (!submissions || Object.keys(submissions).length === 0) {
                const noSubmissionsDiv = document.createElement('div');
                noSubmissionsDiv.className = 'no-submissions';
                noSubmissionsDiv.textContent = '暂无作业信息';
                container.appendChild(noSubmissionsDiv);
                return;
            }

            const colCount = getColumnCount();
            const columns = [];
            for (let i = 0; i < colCount; i++) {
                const col = document.createElement('div');
                col.className = 'column';
                columns.push(col);
            }

            // 收集所有作业项
            const allHomeworkItems = [];
            const subjectOrder = Object.keys(submissions);
            const sortedSubjects = {};
            subjectOrder.forEach(subject => {
                const sortedList = submissions[subject].slice().sort((a, b) => 
                    b.timestamp.localeCompare(a.timestamp));
                
                sortedList.forEach(submission => {
                    allHomeworkItems.push({
                        subject: subject,
                        submission: submission,
                        // 估算高度
                        estimatedHeight: calculateItemHeight(submission)
                    });
                });
            });

            // 智能分配作业到各列
            distributeItemsToColumns(allHomeworkItems, columns, colCount);
            
            columns.forEach(col => {
                if (col.children.length > 0) {
                    container.appendChild(col);
                }
            });
            
            applyHideExpired();
        }

        // 计算作业项的大致高度
        function calculateItemHeight(submission) {
            const baseHeight = 90; // 基础高度
            const contentHeight = Math.ceil(submission.content.length / 25) * 18; // 内容高度估算
            const labelHeight = submission.labels.length > 0 ? 25 : 0; // 标签高度
            return baseHeight + contentHeight + labelHeight;
        }

        // 智能分配作业项到各列
        function distributeItemsToColumns(items, columns, colCount) {
            // 按学科分组
            const subjects = {};
            items.forEach(item => {
                if (!subjects[item.subject]) {
                    subjects[item.subject] = [];
                }
                subjects[item.subject].push(item);
            });

            // 计算各列当前高度
            const columnHeights = new Array(colCount).fill(0);
            const columnSubjects = new Array(colCount).fill(0).map(() => ({}));

            // 按学科总高度排序（从高到低）
            const sortedSubjects = Object.keys(subjects).sort((a, b) => {
                const heightA = subjects[a].reduce((sum, item) => sum + item.estimatedHeight, 0);
                const heightB = subjects[b].reduce((sum, item) => sum + item.estimatedHeight, 0);
                return heightB - heightA;
            });

            // 分配学科到各列
            sortedSubjects.forEach(subject => {
                // 找到当前高度最小的列
                let targetCol = 0;
                let minHeight = columnHeights[0];
                
                for (let i = 1; i < colCount; i++) {
                    if (columnHeights[i] < minHeight) {
                        minHeight = columnHeights[i];
                        targetCol = i;
                    }
                }

                // 将该学科的所有作业项添加到目标列
                subjects[subject].forEach(item => {
                    addHomeworkItemToColumn(item, columns[targetCol], columnSubjects[targetCol]);
                    columnHeights[targetCol] += item.estimatedHeight;
                });
            });
        }

        // 添加作业项到指定列
        function addHomeworkItemToColumn(item, column, columnSubjects) {
            const subject = item.subject;
            const submission = item.submission;
            
            // 检查该列是否已有该学科
            if (!columnSubjects[subject]) {
                // 创建新的学科部分
                const subjectSection = document.createElement('div');
                subjectSection.className = 'subject-section';
                
                const subjectTitle = document.createElement('div');
                subjectTitle.className = 'subject-title';
                subjectTitle.textContent = subject;
                subjectSection.appendChild(subjectTitle);
                
                const homeworkList = document.createElement('ul');
                homeworkList.className = 'homework-list';
                subjectSection.appendChild(homeworkList);
                
                column.appendChild(subjectSection);
                columnSubjects[subject] = homeworkList;
            }
            
            // 创建作业项
            const homeworkItem = document.createElement('li');
            homeworkItem.className = 'homework-item';
            homeworkItem.setAttribute('data-deadline', submission.deadline);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'content-wrapper';

            const contentSpan = document.createElement('span');
            contentSpan.className = 'content';
            contentSpan.textContent = submission.content;
            contentWrapper.appendChild(contentSpan);

            const labelsSpan = document.createElement('span');
            labelsSpan.className = 'labels';
            submission.labels.forEach(labelName => {
                const labelTag = document.createElement('span');
                labelTag.className = 'label-tag';
                labelTag.textContent = labelName;
                const labelObj = globalLabels.find(l => l.name === labelName);
                if (labelObj) {
                    labelTag.style.backgroundColor = labelObj.color;
                }
                labelsSpan.appendChild(labelTag);
            });
            contentWrapper.appendChild(labelsSpan);
            homeworkItem.appendChild(contentWrapper);

            const datesContainer = document.createElement('div');
            datesContainer.className = 'dates-container';

            const deadlineDiv = document.createElement('div');
            deadlineDiv.className = 'deadline';
            deadlineDiv.textContent = '截止日期: ' + submission.deadline.substring(5);
            datesContainer.appendChild(deadlineDiv);

            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'timestamp';
            timestampDiv.textContent = '发布时间: ' + submission.timestamp.substring(5, 16);
            datesContainer.appendChild(timestampDiv);

            homeworkItem.appendChild(datesContainer);
            columnSubjects[subject].appendChild(homeworkItem);
        }
    
        // 打开设置弹窗
        function openSettings() {
            document.getElementById("settingsModal").style.display = "block";
        }
    
        // 关闭设置弹窗
        function closeSettings() {
            document.getElementById("settingsModal").style.display = "none";
        }
    
        // 切换全屏模式
        function toggleFullscreen() {
            const container = document.querySelector('.container');
            isFullscreen = !isFullscreen;
            if (isFullscreen) {
                container.classList.add('fullscreen');
                document.querySelector('.top-buttons button:nth-child(3)').textContent = '退出全屏';
            } else {
                container.classList.remove('fullscreen');
                document.querySelector('.top-buttons button:nth-child(3)').textContent = '全屏';
            }
        }
    
        // 应用隐藏过期作业功能
        function applyHideExpired() {
            const hideExpired = document.getElementById("hideExpired").checked;
            const homeworkItems = document.querySelectorAll(".homework-item");
            if (!hideExpired) {
                homeworkItems.forEach(item => {
                    item.style.display = "block";
                });
                return;
            }
            const now = new Date();
            homeworkItems.forEach(item => {
                const deadlineStr = item.getAttribute("data-deadline");
                const deadline = new Date(deadlineStr);
                if (deadline < now) {
                    item.style.display = "none";
                }
            });
        }
    
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById("settingsModal");
            if (event.target == modal) {
                closeSettings();
            }
        }
    </script>
</body>
</html>